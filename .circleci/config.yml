# DO NOT CHANGE CIRCLE CI CONFIG IN THIS FILE MANUALLY!!!
#
# THIS FILE IS AUTO GENERATED BY THE generate-circleci-config SCRIPT
#
version: 2.1
commands:
  yarn-install:
    steps:
      - run:
          name: Install yarn globally
          command: npm install yarn
      - run:
          name: npx yarn install
          command: yarn
      - run:
          name: npx yarn build
          command: yarn build
  publish-to-npm:
    parameters:
      version:
        type: string
      github_access_token:
        type: string
      npm_registry_url:
        type: string
      npm_registry_auth_token:
        type: string
    steps:
      - run:
          name: Set git user/email config
          command: |
            git config --global user.email "dev@firstdag.com"
            git config --global user.name "FirstDAG"
      - run:
          name: Publish @celo packages to First's npm registry
          command: |
            git remote set-url origin https://<< parameters.github_access_token >>@github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
            URL="<< parameters.npm_registry_url >>"
            echo "${URL#'https:'}/:_authToken=<< parameters.npm_registry_auth_token >>" > ~/.npmrc
            cat ~/.npmrc
            git add -u
            git commit -m "dummy commit to avoid git errors when publishing - should not be pushed ever"
            ./.circleci/publish.sh patch
jobs:
  publish:
    docker:
      - image: circleci/node:12.18.0
    parameters:
      version:
        type: string
      github_access_token:
        type: string
      npm_registry_url:
        type: string
      npm_registry_auth_token:
        type: string
    steps:
      - checkout
      - yarn-install
      - publish-to-npm:
          github_access_token: << parameters.github_access_token >>
          npm_registry_url: << parameters.npm_registry_url >>
          npm_registry_auth_token: << parameters.npm_registry_auth_token >>
          version: << parameters.version >>
workflows:
  production:
    jobs:
      - publish:
          version: patch
          github_access_token: $GITHUB_ACCESS_TOKEN
          npm_registry_url: $NPM_REGISTRY_URL
          npm_registry_auth_token: $NPM_REGISTRY_AUTH_TOKEN
          context: staging
          filters:
            branches:
              only:
                - main
                - publish-npm
